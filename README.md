# UniFi Protect Doorbell Tone Rotator

This script automatically rotates the **visitor tone** (ringtone) of one or more
**UniFi Protect doorbells** by uploading audio files and configuring the doorbell
to use them.

It is designed to be:

- Cron-friendly
- Stateless (safe to run repeatedly)
- Compatible with UniFi OS / UNVR
- Explicitly configurable via JSON
- Careful not to touch unmanaged ringtones

Typical use cases:
- Rotate fun doorbell sounds throughout the day
- Randomize sounds from a curated set
- Control volume and repeat count per sound
- Keep configuration simple and explicit

---

## How it works

On each run, the script:

1. Logs into UniFi OS using a local user account
2. For each configured doorbell:
    - Deletes the previously managed ringtone (if any)
    - Uploads a randomly selected MP3
    - Configures the doorbell to use that ringtone
3. Applies per-sound playback parameters (repeat count, volume)

Each doorbell uses exactly one managed ringtone, named:

doorbell_<camera_id>

This ensures safe replacement without affecting other ringtones.

---

## Requirements

- Python 3.9+
- UniFi Protect running on UniFi OS / UNVR
- A local UniFi OS user account with permission to manage Protect devices
- Network access to the UniFi OS host

---

## Authentication

The script authenticates exactly like the UniFi OS web UI:

- POST /api/auth/login
- Session cookie + CSRF token
- Reused for all Protect API calls

### Required environment variables

UNVR_USER and UNVR_PASSWORD must be set:

export UNVR_USER=your_username
export UNVR_PASSWORD=your_password

Credentials are intentionally not stored in the config file.

---

## Quick start

### 1. Clone the repository

git clone <your-repo-url>
cd unvr-doorbell-chime-rotator

### 2. (Optional) Create a virtual environment

python3 -m venv .venv
source .venv/bin/activate
pip install requests

### 3. Prepare a sounds directory

Example:

sounds/
├── ding.mp3
├── dramatic.mp3
└── silly.mp3

---

### 4. Run initial configuration

./doorbell_tone_rotator.py --configure

You will be prompted for:
- UniFi OS base URL
- Sounds directory (relative to the script)
- Default playback parameters
- Doorbells to include in rotation

This creates a JSON config file (default: ~/.unifi_tone_rotation.json).

---

### 5. Run the script

./doorbell_tone_rotator.py

Example output:

[INFO] Deleting existing ringtone id=...
[INFO] Uploading ding.mp3 as 'doorbell_...'
[INFO] Setting doorbell ... (repeat=1 volume=50)
[INFO] Rotation run completed successfully

---

## Running from cron

The script is safe to run from cron because all paths are resolved from the script
location and the config file.

Example (every 15 minutes):

*/15 * * * * UNVR_USER=xxx UNVR_PASSWORD=yyy /path/to/doorbell_tone_rotator.py

---

## Configuration file

The configuration file is JSON.

### Minimal configuration (generated by --configure)

{
"base_url": "https://192.168.1.10",
"base_path": "/path/to/unvr-doorbell-chime-rotator",
"sounds_path": "sounds",
"doorbell_ids": [
"693842d0002fb303e4f7368c"
],
"default_sound_properties": {
"play_times": 1,
"volume_percentage": 50
}
}

---

## Sound selection behavior

### Default behavior (no sound_properties)

If sound_properties is not present, the script:

- Randomly selects an MP3 from sounds_path
- Uses default_sound_properties
- Falls back to play_times=1 and volume_percentage=50 if defaults are missing

---

## Advanced configuration: sound_properties

You may optionally define a curated list of sounds with per-sound settings.

{
"sound_properties": [
{
"file_name": "ding.mp3",
"play_times": 1,
"volume_percentage": 50
},
{
"file_name": "dramatic.mp3",
"play_times": 4,
"volume_percentage": 100
},
{
"file_name": "quiet.mp3",
"path": "special_sounds",
"volume_percentage": 25
}
]
}

### Resolution rules

For each run:

1. A random entry is selected from sound_properties
2. Path resolution:
    - Absolute path → used directly
    - Relative path → relative to base_path
    - No path → relative to sounds_path
3. Playback parameters resolve in this order:
    - Per-sound value
    - default_sound_properties
    - Hard fallback (1 play, 50% volume)

---

## Playback parameters

play_times
- Number of repeats
- Maps to speakerSettings.repeatTimes

volume_percentage
- Ring volume (0–100)
- Maps to speakerSettings.ringVolume

---

## Safety notes

- Only ringtones named doorbell_<camera_id> are ever deleted
- Default UniFi ringtones and manually uploaded ringtones are untouched
- The script is idempotent and safe to re-run

---

## Troubleshooting

### Authentication failures
- Verify UNVR_USER and UNVR_PASSWORD
- The user must be a local UniFi OS user
- Cloud-only users will not work

### No sound changes
- Verify the doorbell supports custom visitor tones
- Run with verbose logging:

./doorbell_tone_rotator.py --verbose

---

## License

Licensed under the GNU General Public License v3.0 or later.
This project is not affiliated with or endorsed by Ubiquiti.
